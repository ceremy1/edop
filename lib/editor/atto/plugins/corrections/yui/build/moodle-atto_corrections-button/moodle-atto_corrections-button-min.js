YUI.add("moodle-atto_corrections-button",function(e,t){var n="atto_corrections",r={FORM:"atto_formcorrections",SPAN:"atto_corrections",CORRSPAN:"atto_corrections_correction",CORRTEXT:"atto_corrections_comment",BASECLASS:"atto_corrections_",SELECT:"atto_corrections_select",TEXTAREA:"atto_corrections_textarea",FULLTEXT:"atto_corrections_fulltext"},i={SPAN:"."+r.SPAN,SELECT:"."+r.SELECT,TEXTAREA:"."+r.TEXTAREA},s={DIALOGUE:'<form class="atto_form {{CSS.FORM}}"><label for="{{elementid}}_atto_corrections_corrtype">{{get_string "corrtype" component}}</label><select id="{{elementid}}_atto_corrections_corrtype" class="{{CSS.SELECT}}">{{#each corrtypes}}<option value="{{{abbr}}}">{{{descr}}}</option>{{/each}}</select><label for="{{elementid}}_atto_corrections_corrtext">{{get_string "corrtext" component}}</label><textarea class="fullwidth {{CSS.TEXTAREA}}" type="text" id="{{elementid}}_atto_corrections_corrtext"></textarea><div class="mdl-align"><br/><button class="submit" type="submit">{{get_string "addcomment" component}}</button></div></form>',FULLTEXT:'<div class="{{CSS.FULLTEXT}}">{{fulltext}}</div>'};e.namespace("M.atto_corrections").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_content:null,_isoncorr:null,initializer:function(){tttt=this;var t=[],r=0;e.Array.each(this.get("corrtypes"),function(e){t.push({text:e.descr,callbackArgs:new Array(r,e.descr)}),r++}),this.addToolbarMenu({icon:M.util.image_url("icon1",n),globalItemConfig:{callback:this._addCorrection},items:t,buttonName:"corrections1",title:"addmark"}),this.addButton({icon:M.util.image_url("icon2",n),callback:this._removeCorrection,tags:i.SPAN,buttonName:"corrections2",title:"removemark"}),this.addButton({icon:M.util.image_url("icon3",n),callback:this._displayFulltext,buttonName:"corrections3",title:"displayfulltext"}),this.get("host").on("pluginsloaded",function(){this.get("host").on("atto:selectionchanged",this._updateButtonsStates,this)},this),this._updateButtonsStates()},_addCorrection:function(e,t){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1||this._currentSelection.collapsed)return;var n=this.get("host").getSelectionParentNode();if(!n)return;this._displayDialogue(t,n)},_removeCorrection:function(t){t.preventDefault();var n=this.get("host").getSelectionParentNode().parentNode;n.nodeName.toLowerCase()==="span"&&n.className.indexOf(r.SPAN)!==-1&&(e.Node(n).one("."+r.CORRSPAN).remove(),n.parentNode.replaceChild(document.createTextNode(n.innerHTML),n))},_displayFulltext:function(){var t=this.getDialogue({headerContent:M.util.get_string("fulltexttitle",n),focusAfterHide:!0,width:600}),i=e.Handlebars.compile(s.FULLTEXT),o=e.Node.create(i({component:n,CSS:r,fulltext:new e.Handlebars.SafeString(this.get("host").editor.getHTML())}));t.set("bodyContent",o).show()},_displayDialogue:function(t,s){nnnn=s;var o=!1,u=!1;this._isoncorr&&(o=s.parentNode.className.replace(r.SPAN+" "+r.BASECLASS,"").replace(" ",""),u=e.Node(s.parentNode).one(".atto_corrections_comment").getDOMNode().innerHTML);var a=this.getDialogue({headerContent:M.util.get_string("dialogtitle",n),focusAfterHide:!0,focusOnShowSelector:i.TEXTAREA});a.set("bodyContent",this._getDialogueContent()).show(),this._isoncorr?(e.one(".atto_form."+r.FORM+" select").set("selectedIndex",this.get("corrtypekeys").indexOf(o)),e.one(".atto_form."+r.FORM+" textarea").set("value",u)):e.one(".atto_form."+r.FORM+" select").set("selectedIndex",t[0])},_getDialogueContent:function(){var t=e.Handlebars.compile(s.DIALOGUE);return this._content=e.Node.create(t({component:n,elementid:this.get("host").get("elementid"),CSS:r,corrtypes:this.get("corrtypes")})),this._content.one(".submit").on("click",this._setCorrection,this),this._content},_setCorrection:function(t){t.preventDefault(),this.getDialogue({focusAfterHide:this._currentSelection}).hide();var n=t.currentTarget.ancestor(".atto_form"),s=n.one(i.SELECT).get("value"),o=n.one(i.TEXTAREA).get("value"),u=this.get("host");ffff=n;if(s!==""){u.setSelection(this._currentSelection);if(this._isoncorr){var a=e.Node(u.getSelectionParentNode().parentNode);a.one("."+r.CORRTEXT).getDOMNode().innerHTML=o;var f=r.SPAN+" "+r.BASECLASS+s;a.one("."+r.CORRTEXT).getDOMNode().parentNode.parentNode.className=f,a.one("sup").getDOMNode().innerHTML=s}else{var l="ts"+(new Date).getTime();u.toggleInlineSelectionClass([r.SPAN]),u.toggleInlineSelectionClass([r.BASECLASS+s]),u.toggleInlineSelectionClass([l]);var c=e.Node.create('<span class="'+r.CORRSPAN+'"/>'),h=e.Node.create('<span class="'+r.CORRTEXT+'">'+o+"</span>"),p=e.Node.create('<sup title="'+o+'">'+s+"</sup>");e.one("."+l).appendChild(c),e.one("."+l).removeClass(l),c.appendChild(p.getDOMNode()),c.appendChild(h.getDOMNode())}this.markUpdated()}},_updateButtonsStates:function(){var e=this.get("host").getSelectionParentNode().parentNode,t=rangy.getSelection();if(!t.rangeCount){this.disableButtons("corrections1"),this.disableButtons("corrections2");return}var n=t.getRangeAt(0);this._isoncorr=e.nodeName.toLowerCase()==="span"&&e.className.indexOf(r.SPAN)!==-1,this._isoncorr?this.enableButtons("corrections2"):this.disableButtons("corrections2"),n.collapsed&&!this._isoncorr||!n.collapsed&&this._isoncorr?this.disableButtons("corrections1"):this.enableButtons("corrections1")}},{ATTRS:{corrtypes:{value:{}},corrtypekeys:{value:{}}}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
